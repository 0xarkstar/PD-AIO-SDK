name: API Compatibility Check

on:
  # Run weekly on Monday at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      exchange:
        description: 'Specific exchange to check (leave empty for all)'
        required: false
        type: string

  # Run on PRs that modify API specs
  pull_request:
    paths:
      - 'tests/api-contracts/**'
      - 'scripts/check-api-compatibility.ts'

jobs:
  check-compatibility:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run API compatibility check
        id: check
        continue-on-error: true
        run: |
          if [ -n "${{ github.event.inputs.exchange }}" ]; then
            npm run check:api -- ${{ github.event.inputs.exchange }}
          else
            npm run check:api
          fi

      - name: Upload compatibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-compatibility-report
          path: reports/api-compatibility-*.md
          retention-days: 30

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reports = fs.readdirSync('reports').filter(f => f.startsWith('api-compatibility'));
            if (reports.length > 0) {
              const latestReport = reports.sort().reverse()[0];
              const reportContent = fs.readFileSync(`reports/${latestReport}`, 'utf8');

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.name,
                body: `## âš ï¸ API Compatibility Check Failed\n\n${reportContent}`
              });
            }

      - name: Create issue on failure (scheduled run only)
        if: github.event_name == 'schedule' && steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reports = fs.readdirSync('reports').filter(f => f.startsWith('api-compatibility'));
            if (reports.length > 0) {
              const latestReport = reports.sort().reverse()[0];
              const reportContent = fs.readFileSync(`reports/${latestReport}`, 'utf8');

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.name,
                title: `[API Breaking Change] Compatibility check failed on ${new Date().toISOString().split('T')[0]}`,
                body: `## ðŸš¨ API Compatibility Issue Detected\n\nThe weekly API compatibility check has detected breaking changes.\n\n${reportContent}`,
                labels: ['P0-Critical', 'api-compatibility', 'automated']
              });
            }

      - name: Fail workflow if check failed
        if: steps.check.outcome == 'failure'
        run: exit 1
