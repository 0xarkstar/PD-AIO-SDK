# Alertmanager Configuration

global:
  resolve_timeout: 5m
  # Slack webhook URL (í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê¶Œì¥)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# ì•Œë¦¼ í…œí”Œë¦¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ì•Œë¦¼ ë¼ìš°íŒ…
route:
  # ê¸°ë³¸ ìˆ˜ì‹ ì
  receiver: 'default'

  # ì•Œë¦¼ ê·¸ë£¹í™” (ê°™ì€ ë ˆì´ë¸”ì„ ê°€ì§„ ì•Œë¦¼ì„ ë¬¶ìŒ)
  group_by: ['alertname', 'cluster', 'service']

  # ì²« ì•Œë¦¼ ëŒ€ê¸° ì‹œê°„ (ê·¸ë£¹í™”ë¥¼ ìœ„í•´)
  group_wait: 10s

  # ê·¸ë£¹ì— ìƒˆ ì•Œë¦¼ ì¶”ê°€ ëŒ€ê¸° ì‹œê°„
  group_interval: 10s

  # ê°™ì€ ì•Œë¦¼ ì¬ì „ì†¡ ì£¼ê¸°
  repeat_interval: 12h

  # ë¼ìš°íŒ… ê·œì¹™
  routes:
    # Critical ì•Œë¦¼ - ì¦‰ì‹œ Slackìœ¼ë¡œ ì „ì†¡
    - match:
        severity: critical
      receiver: 'slack-critical'
      group_wait: 5s
      repeat_interval: 3h

    # Warning ì•Œë¦¼ - Slackìœ¼ë¡œ ì „ì†¡ (ëœ ê¸´ê¸‰)
    - match:
        severity: warning
      receiver: 'slack-warnings'
      group_wait: 30s
      repeat_interval: 6h

    # Circuit Breaker ê´€ë ¨ ì•Œë¦¼
    - match:
        component: circuit_breaker
      receiver: 'slack-circuit-breaker'
      group_wait: 10s
      repeat_interval: 4h

# ì•Œë¦¼ ìˆ˜ì‹ ì ì •ì˜
receivers:
  # ê¸°ë³¸ ìˆ˜ì‹ ì (ë¡œê·¸ë§Œ)
  - name: 'default'
    # webhook_configs:
    #   - url: 'http://localhost:5001/'

  # Critical ì•Œë¦¼ - Slack
  - name: 'slack-critical'
    slack_configs:
      - channel: '#perpdex-alerts-critical'
        username: 'Perp DEX Alertmanager'
        icon_emoji: ':fire:'
        title: 'ğŸš¨ Critical Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Exchange:* {{ .Labels.exchange }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
          {{ end }}
        send_resolved: true

  # Warning ì•Œë¦¼ - Slack
  - name: 'slack-warnings'
    slack_configs:
      - channel: '#perpdex-alerts-warnings'
        username: 'Perp DEX Alertmanager'
        icon_emoji: ':warning:'
        title: 'âš ï¸ Warning Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Exchange:* {{ .Labels.exchange }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

  # Circuit Breaker ì•Œë¦¼ - Slack
  - name: 'slack-circuit-breaker'
    slack_configs:
      - channel: '#perpdex-circuit-breaker'
        username: 'Perp DEX Alertmanager'
        icon_emoji: ':electric_plug:'
        title: 'ğŸ”Œ Circuit Breaker Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Exchange:* {{ .Labels.exchange }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

# ì•Œë¦¼ ì–µì œ ê·œì¹™ (ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€)
inhibit_rules:
  # Critical ì•Œë¦¼ì´ ë°œìƒí•˜ë©´ ê°™ì€ ëŒ€ìƒì˜ Warning ì–µì œ
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'exchange', 'operation']

  # Circuit Breaker OPEN ì‹œ ê´€ë ¨ ì—ëŸ¬ ì•Œë¦¼ ì–µì œ
  - source_match:
      alertname: 'CircuitBreakerOpen'
    target_match:
      component: 'requests'
    equal: ['exchange']
